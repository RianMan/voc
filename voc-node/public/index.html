<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SmartQarza VOC ç›‘æ§çœ‹æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="bg-gray-100 p-8">
    <div class="max-w-7xl mx-auto">
      <div class="mb-8 flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold text-gray-800">
            ğŸ“Š SmartQarza å®¢æˆ·èˆ†æƒ…çœ‹æ¿
          </h1>
          <p class="text-gray-500 mt-2">
            åŸºäº DeepSeek AI å®æ—¶åˆ†æ â€¢ å·´åŸºæ–¯å¦åŒº
          </p>
        </div>
        <button
          onclick="location.reload()"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition"
        >
          åˆ·æ–°æ•°æ®
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white p-6 rounded-lg shadow border-l-4 border-blue-500">
          <h3 class="text-gray-500 text-sm">æ€»è¯„è®ºæ•°</h3>
          <p class="text-3xl font-bold mt-2" id="total-count">-</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow border-l-4 border-red-500">
          <h3 class="text-gray-500 text-sm">âš ï¸ é«˜é£é™© (High Risk)</h3>
          <p class="text-3xl font-bold mt-2 text-red-600" id="risk-count">-</p>
        </div>
        <div
          class="bg-white p-6 rounded-lg shadow border-l-4 border-yellow-500"
        >
          <h3 class="text-gray-500 text-sm">æŠ€æœ¯æ•…éšœ (Tech Bug)</h3>
          <p class="text-3xl font-bold mt-2" id="bug-count">-</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow border-l-4 border-green-500">
          <h3 class="text-gray-500 text-sm">æ­£é¢å¥½è¯„ (Positive)</h3>
          <p class="text-3xl font-bold mt-2" id="positive-count">-</p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="font-bold mb-4 text-gray-700">èˆ†æƒ…ç±»åˆ«å æ¯”</h3>
          <canvas id="categoryChart"></canvas>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="font-bold mb-4 text-gray-700">é£é™©ç­‰çº§åˆ†å¸ƒ</h3>
          <canvas id="riskChart"></canvas>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="font-bold text-lg text-gray-800">
            ğŸš¨ é‡ç‚¹å…³æ³¨åˆ—è¡¨ (æŒ‰é£é™©æ’åº)
          </h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr
                class="bg-gray-50 text-gray-600 text-sm uppercase tracking-wider"
              >
                <th class="px-6 py-3 border-b">é£é™©ç­‰çº§</th>
                <th class="px-6 py-3 border-b">åˆ†ç±»</th>
                <th class="px-6 py-3 border-b">æ‘˜è¦ (AIç”Ÿæˆ)</th>
                <th class="px-6 py-3 border-b">ä¸­æ–‡ç¿»è¯‘</th>
                <th class="px-6 py-3 border-b">ID</th>
              </tr>
            </thead>
            <tbody id="table-body" class="text-gray-700 text-sm"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      // è·å–æ•°æ®å¹¶æ¸²æŸ“
      fetch("/api/voc-data")
        .then((res) => res.json())
        .then((data) => {
          renderCards(data);
          renderCharts(data);
          renderTable(data);
        });

      function renderCards(data) {
        document.getElementById("total-count").innerText = data.length;
        document.getElementById("risk-count").innerText = data.filter(
          (i) => i.risk_level === "High"
        ).length;
        document.getElementById("bug-count").innerText = data.filter(
          (i) => i.category === "Tech_Bug"
        ).length;
        document.getElementById("positive-count").innerText = data.filter(
          (i) => i.category === "Positive"
        ).length;
      }

      function renderCharts(data) {
        // ç»Ÿè®¡åˆ†ç±»
        const categories = {};
        data.forEach((item) => {
          categories[item.category] = (categories[item.category] || 0) + 1;
        });

        // 1. é¥¼å›¾ (åˆ†ç±»)
        new Chart(document.getElementById("categoryChart"), {
          type: "doughnut",
          data: {
            labels: Object.keys(categories),
            datasets: [
              {
                data: Object.values(categories),
                backgroundColor: [
                  "#10B981",
                  "#EF4444",
                  "#F59E0B",
                  "#3B82F6",
                  "#6366F1",
                  "#9CA3AF",
                ],
              },
            ],
          },
        });

        // ç»Ÿè®¡é£é™©
        const risks = { High: 0, Medium: 0, Low: 0 };
        data.forEach((item) => {
          if (risks[item.risk_level] !== undefined) risks[item.risk_level]++;
        });

        // 2. æŸ±çŠ¶å›¾ (é£é™©)
        new Chart(document.getElementById("riskChart"), {
          type: "bar",
          data: {
            labels: ["ä½é£é™©", "ä¸­é£é™©", "é«˜é£é™©"],
            datasets: [
              {
                label: "æ•°é‡",
                data: [risks.Low, risks.Medium, risks.High],
                backgroundColor: ["#D1FAE5", "#FDE68A", "#FECACA"],
                borderColor: ["#10B981", "#F59E0B", "#EF4444"],
                borderWidth: 1,
              },
            ],
          },
        });
      }

      function renderTable(data) {
        const tbody = document.getElementById("table-body");

        // æ’åºï¼šHigh > Medium > Low
        const riskOrder = { High: 1, Medium: 2, Low: 3 };
        const sortedData = data.sort(
          (a, b) =>
            (riskOrder[a.risk_level] || 3) - (riskOrder[b.risk_level] || 3)
        );

        sortedData.forEach((item) => {
          const tr = document.createElement("tr");
          tr.className = "hover:bg-gray-50 border-b";

          // é£é™©æ ‡ç­¾æ ·å¼
          let badgeClass = "bg-gray-100 text-gray-800";
          if (item.risk_level === "High")
            badgeClass = "bg-red-100 text-red-800 font-bold";
          if (item.risk_level === "Medium")
            badgeClass = "bg-yellow-100 text-yellow-800";

          tr.innerHTML = `
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs ${badgeClass}">${
            item.risk_level
          }</span></td>
                    <td class="px-6 py-4 font-medium">${item.category}</td>
                    <td class="px-6 py-4">${item.summary}</td>
                    <td class="px-6 py-4 text-gray-500 italic">${
                      item.translated_text || item.text
                    }</td>
                    <td class="px-6 py-4 text-xs text-gray-400 font-mono">${item.id.substring(
                      0,
                      8
                    )}...</td>
                `;
          tbody.appendChild(tr);
        });
      }
    </script>
  </body>
</html>
